<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>City Temperature Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; height: 100%; }
    #map { position: absolute; inset: 0; }
    #ui {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: #fff; padding: 12px; border-radius: 10px;
      font: 14px/1.25 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 4px 20px rgba(0,0,0,.12); width: 330px;
    }
    #ui label { display: block; margin: 8px 0 4px; font-weight: 600; }
    #ui .row { display: flex; gap: 8px; align-items: center; }
    #ui .row input[type=range] { flex: 1; }
    #badge {
      position: absolute; bottom: 10px; left: 10px; z-index: 10;
      background: #fff; padding: 6px 8px; border-radius: 8px;
      font: 12px system-ui, sans-serif; box-shadow: 0 2px 12px rgba(0,0,0,.12);
    }
    #chartContainer {
      position:absolute; top:10px; right:10px; width:360px; height:240px;
      background:#fff; opacity:0.98; padding:10px; border-radius:8px;
      display:none; z-index:20;
    }
    #legend {
      position: absolute; bottom: 10px; right: 10px; z-index: 10;
      background: #fff; padding: 8px 10px; border-radius: 8px;
      font: 12px system-ui, sans-serif; box-shadow: 0 2px 12px rgba(0,0,0,.12);
      width: 300px;
    }
    #legend .bar {
      height: 12px; border-radius: 6px; margin: 6px 0;
      background: linear-gradient(to right,
        rgb(0,0,255),
        rgb(0,255,255),
        rgb(0,255,0),
        rgb(255,255,0),
        rgb(255,165,0),
        rgb(255,0,0),
        rgb(128,0,0)
      );
    }
    #legend .tickrow { display:flex; justify-content:space-between; color:#333; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="ui">
    <div class="row" style="justify-content:space-between;">
      <strong>Temperature Heatmap</strong>
      <span id="status" style="opacity:.7;">loading…</span>
    </div>

    <label for="hour">Hour</label>
    <div class="row">
      <input id="hour" type="range" min="0" max="23" step="1" value="19" />
      <span id="hourLabel" style="width:68px; text-align:right;">19:00</span>
    </div>

    <label for="place">Place</label>
    <select id="place">
      <option value="__all__">All places</option>
      <option value="sparafucile">sparafucile</option>
      <option value="parcote">parcote</option>
    </select>

    <label for="radius">Heatmap radius</label>
    <div class="row">
      <input id="radius" type="range" min="5" max="60" step="1" value="26" />
      <span id="radiusLabel" style="width:36px; text-align:right;">26</span>
    </div>

    <label for="intensity">Heatmap intensity</label>
    <div class="row">
      <input id="intensity" type="range" min="0.1" max="3" step="0.1" value="1.0" />
      <span id="intensityLabel" style="width:36px; text-align:right;">1.0</span>
    </div>
  </div>

  <div id="badge">PMTiles: Cloudflare R2 · MapLibre GL</div>

  <div id="legend">
    <div><strong>Color scale (°C)</strong></div>
    <div class="bar"></div>
    <div class="tickrow">
      <span>0</span><span>10</span><span>20</span><span>25</span><span>30</span><span>35</span><span>40+</span>
    </div>
  </div>

  <div id="chartContainer">
    <canvas id="tempChart"></canvas>
  </div>

  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script type="module">
    import * as pmtiles from "https://unpkg.com/pmtiles@3.0.7/dist/index.js";
    import Pbf from "https://esm.sh/pbf@3.2.1";
    import { VectorTile } from "https://esm.sh/@mapbox/vector-tile@1.3.1";

    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);

    // Config
    const PMTILES_URL = "https://pub-7d28cd0e85994386bd14b8b8fa86a6d7.r2.dev/all_temps.pmtiles";
    const DATE = "2025-07-23";
    const INIT_CENTER = [10.80, 45.16];
    const INIT_ZOOM = 12.2;
    const LAYER_NAME = "temps";

    const pm = new pmtiles.PMTiles(PMTILES_URL);
    protocol.add(pm);

    const urlParams = new URLSearchParams(location.search);
    const initHour = Number(urlParams.get("hour") ?? 19);
    const initPlace = urlParams.get("place") ?? "__all__";

    const map = new maplibregl.Map({
      container: "map",
      center: INIT_CENTER,
      zoom: INIT_ZOOM,
      style: {
        version: 8,
        sources: {
          basemap: {
            type: "raster",
            tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
            tileSize: 256
          },
          temps: { type: "vector", url: `pmtiles://${PMTILES_URL}` }
        },
        layers: [
          { id: "basemap", type: "raster", source: "basemap" },
          {
            id: "heat",
            type: "heatmap",
            source: "temps",
            "source-layer": LAYER_NAME,
            paint: {
              "heatmap-weight": 1,
              "heatmap-radius": 26,
              "heatmap-intensity": 1.0,
              "heatmap-opacity": 0.9,
              "heatmap-color": [
                "interpolate", ["linear"], ["get", "value"],
                 0,  "rgb(0,0,255)",
                10, "rgb(0,255,255)",
                20, "rgb(0,255,0)",
                25, "rgb(255,255,0)",
                30, "rgb(255,165,0)",
                35, "rgb(255,0,0)",
                40, "rgb(128,0,0)"
              ]
            },
            filter: ["==", ["get", "time"], `${DATE}T${String(initHour).padStart(2,"0")}:00`]
          },
          {
            id: "points",
            type: "circle",
            source: "temps",
            "source-layer": LAYER_NAME,
            paint: {
              "circle-radius": 3,
              "circle-color": "rgba(0,0,0,0)"
            },
            filter: ["==", ["get", "time"], `${DATE}T${String(initHour).padStart(2,"0")}:00`]
          }
        ]
      }
    });

    const $status = document.getElementById("status");
    const $hour = document.getElementById("hour");
    const $hourLabel = document.getElementById("hourLabel");
    const $place = document.getElementById("place");
    const $radius = document.getElementById("radius");
    const $radiusLabel = document.getElementById("radiusLabel");
    const $intensity = document.getElementById("intensity");
    const $intensityLabel = document.getElementById("intensityLabel");
    const chartContainer = document.getElementById("chartContainer");
    const ctx = document.getElementById("tempChart").getContext("2d");
    let chart = null;

    function currentTimeStr() {
      const h = Number($hour.value);
      return `${DATE}T${String(h).padStart(2,"0")}:00`;
    }

    function applyFilters() {
      const timeFilter = ["==", ["get", "time"], currentTimeStr()];
      const placeVal = $place.value;
      const filter = (placeVal === "__all__")
        ? timeFilter
        : ["all", timeFilter, ["==", ["get","place"], placeVal]];
      map.setFilter("heat", filter);
      map.setFilter("points", filter);
    }

    function applyPaint() {
      map.setPaintProperty("heat", "heatmap-radius", Number($radius.value));
      map.setPaintProperty("heat", "heatmap-intensity", Number($intensity.value));
      $radiusLabel.textContent = $radius.value;
      $intensityLabel.textContent = $intensity.value;
    }

    $hour.addEventListener("input", () => {
      $hourLabel.textContent = `${String($hour.value).padStart(2,"0")}:00`;
      applyFilters();
    });
    $place.addEventListener("change", applyFilters);
    $radius.addEventListener("input", applyPaint);
    $intensity.addEventListener("input", applyPaint);

    map.on("load", () => {
      $status.textContent = "ready";
      applyFilters();
      applyPaint();
    });

    // Hover popup
    let popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });
    map.on("mousemove", (e) => {
      const features = map.queryRenderedFeatures(e.point, { layers: ["points"] });
      if (!features.length) { popup.remove(); return; }
      const f = features[0];
      popup.setLngLat(f.geometry.coordinates)
        .setHTML(`<strong>${Number(f.properties.value).toFixed(1)}°C</strong><br>${f.properties.time}<br>${f.properties.place}`)
        .addTo(map);
    });

    // Click → real chart from PMTiles
    map.on("click", async (e) => {
      const features = map.queryRenderedFeatures(e.point, { layers: ["points"] });
      if (!features.length) { chartContainer.style.display = "none"; return; }
      const f = features[0];
      const clickedPlace = f.properties.place;

      const series = await getPlaceSeriesFromPMTiles(pm, e.lngLat, clickedPlace, DATE);
      if (!series.hours.length) { chartContainer.style.display = "none"; return; }

      chartContainer.style.display = "block";
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: series.hours,
          datasets: [{
            label: `Temperature at ${clickedPlace}`,
            data: series.values,
            borderColor: 'rgb(255,0,0)',
            backgroundColor: 'rgba(255,0,0,0.15)',
            tension: 0.3
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { y: { title: { display: true, text: "°C" } } }
        }
      });
    });

    // Helpers
    function lng2tile(lon, z) { return Math.floor((lon + 180) / 360 * Math.pow(2, z)); }
    function lat2tile(lat, z) {
      const rad = lat * Math.PI / 180;
      return Math.floor((1 - Math.log(Math.tan(rad) + 1 / Math.cos(rad)) / Math.PI) / 2 * Math.pow(2, z));
    }

    async function getPlaceSeriesFromPMTiles(pmReader, lngLat, place, dateStr) {
      const z = 12;
      const x = lng2tile(lngLat.lng, z);
      const y = lat2tile(lngLat.lat, z);
      const tile = await pmReader.getZxy(z, x, y).catch(() => null);
      if (!tile || !tile.data) return { hours: [], values: [] };

      const bytes = new Uint8Array(tile.data);
      const vt = new VectorTile(new Pbf(bytes));
      const layer = vt.layers[LAYER_NAME];
      if (!layer) return { hours: [], values: [] };

      let records = [];
      for (let i = 0; i < layer.length; i++) {
        const feat = layer.feature(i);
        const props = feat.properties || {};
        if (props.place !== place) continue;
        if (!String(props.time).startsWith(dateStr)) continue;
        records.push({ hhmm: props.time.slice(11,16), v: Number(props.value) });
      }
      records.sort((a,b)=>a.hhmm.localeCompare(b.hhmm));
      return { hours: records.map(r=>r.hhmm), values: records.map(r=>r.v) };
    }
  </script>
</body>
</html>

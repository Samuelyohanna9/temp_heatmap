<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>City Temperature Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="vendor/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; height: 100%; }
    #map { position: absolute; inset: 0; }
    #ui {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: #fff; padding: 12px; border-radius: 10px;
      font: 14px/1.25 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 4px 20px rgba(0,0,0,.12); width: 320px;
    }
    #ui label { display: block; margin: 8px 0 4px; font-weight: 600; }
    #ui .row { display: flex; gap: 8px; align-items: center; }
    #ui .row input[type=range] { flex: 1; }
    #badge {
      position: absolute; bottom: 10px; left: 10px; z-index: 10;
      background: #fff; padding: 6px 8px; border-radius: 8px;
      font: 12px system-ui, sans-serif; box-shadow: 0 2px 12px rgba(0,0,0,.12);
    }
    #chartContainer {
      position:absolute; top:10px; right:10px; width:360px; height:240px;
      background:#fff; opacity:0.95; padding:10px; border-radius:8px;
      display:none; z-index:20;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="ui">
    <div class="row" style="justify-content:space-between;">
      <strong>Temperature Heatmap</strong>
      <span id="status" style="opacity:.7;">loading…</span>
    </div>

    <label for="hour">Hour</label>
    <div class="row">
      <input id="hour" type="range" min="0" max="23" step="1" value="19" />
      <span id="hourLabel" style="width:80px; text-align:right;">19:00</span>
    </div>

    <label for="place">Place</label>
    <select id="place">
      <option value="__all__">All places</option>
      <option value="sparafucile">sparafucile</option>
      <option value="parcote">parcote</option>
    </select>
  </div>

  <div id="badge">Data: PMTiles (Cloudflare R2) · MapLibre GL</div>
  <div id="chartContainer"><canvas id="tempChart"></canvas></div>

  <script src="vendor/maplibre-gl.js"></script>
  <script src="vendor/pmtiles.js"></script>
  <script src="vendor/basemaps.js"></script>
  <script src="vendor/pbf.min.js"></script>
  <script src="vendor/vector-tile.js"></script>
  <script src="vendor/chart.umd.js"></script>
  <script src="vendor/chartjs-plugin-annotation.min.js"></script>
  <script>
    if (window['chartjs-plugin-annotation']) Chart.register(window['chartjs-plugin-annotation']);
    else if (window.ChartAnnotation) Chart.register(window.ChartAnnotation);
  </script>

  <script>
    // --- Config ---
    const PMTILES_BASEMAP = "https://pub-7d28cd0e85994386bd14b8b8fa86a6d7.r2.dev/mantua_basemap.pmtiles";
    const PMTILES_TEMPS   = "https://pub-7d28cd0e85994386bd14b8b8fa86a6d7.r2.dev/all_temps.pmtiles";
    const LAYER_NAME = "temps";
    const DATE = "2025-07-23";
    const INIT_CENTER = [10.80, 45.16];
    const INIT_ZOOM = 12.2;
    const DECODE_ZOOM = 14;
    const CLICK_MAX_M = 60;
    const DATA_BOUNDS = [10.785482, 45.145304, 10.814915, 45.167814];

    const hours24 = Array.from({length:24}, (_,i)=> `${DATE}T${String(i).padStart(2,"0")}:00`);
    const currentTimeStr = () => `${DATE}T${String($hour.value).padStart(2,"0")}:00`;

    // --- DOM refs ---
    const $status = document.getElementById("status");
    const $hour = document.getElementById("hour");
    const $hourLabel = document.getElementById("hourLabel");
    const $place = document.getElementById("place");
    const chartContainer = document.getElementById("chartContainer");
    let chart = null;

    // --- PMTiles protocol ---
    const protocol = new pmtiles.Protocol();
    maplibregl.addProtocol("pmtiles", protocol.tile);
    const archiveTemps = new pmtiles.PMTiles(PMTILES_TEMPS);
    const archiveBase  = new pmtiles.PMTiles(PMTILES_BASEMAP);
    protocol.add(archiveTemps);
    protocol.add(archiveBase);

    // --- helpers (same as before) ---
    function lonlatToTile(lon, lat, z) { /* ... unchanged ... */ }
    const wrap = (n, mod) => ((n % mod) + mod) % mod;
    function haversine(lon1, lat1, lon2, lat2) { /* ... unchanged ... */ }
    async function decodeTileToPoints(z, x, y) { /* ... unchanged ... */ }
    async function decodeBoundsToPoints(bounds = DATA_BOUNDS, z = DECODE_ZOOM) { /* ... unchanged ... */ }
    async function pickNearbyFeature(lon, lat, placeFilter) { /* ... unchanged ... */ }
    async function loadSeriesByPixelId(pixelId, lonHint, latHint, placeFilter) { /* ... unchanged ... */ }

    // --- style and cache ---
    const basemapSourceId = "basemap";
    const style = { /* ... unchanged ... */ };
    const globalMinMaxCache = new Map();
    async function getGlobalMinMaxFor(hourStr, placeValue) { /* ... unchanged ... */ }
    async function applyGlobalHeatScale() { /* ... unchanged ... */ }
    function buildFilter() { /* ... unchanged ... */ }
    async function applyFilters() { /* ... unchanged ... */ }

    // --- Map init ---
    const map = new maplibregl.Map({ container: "map", style, center: INIT_CENTER, zoom: INIT_ZOOM, maxZoom: 22 });
    map.addControl(new maplibregl.NavigationControl(), "top-right");
    map.addControl(new maplibregl.ScaleControl({ unit: "metric" }));
    map.on("error", (e) => console.error("Map error:", e?.error || e));

    map.on("load", () => {
      $status.textContent = "ready";

      // fixed heatmap layer
      map.addLayer({
        id: "heat",
        type: "heatmap",
        source: "temps",
        "source-layer": LAYER_NAME,
        paint: {
          "heatmap-weight": ["interpolate", ["linear"], ["get","value"], 24,0, 36,1],

          "heatmap-radius": ["interpolate", ["exponential", 1.8], ["zoom"],
            8, 18,
            12, 42,
            14, 72,
            16, 110,
            18, 160,
            20, 220
          ],

          "heatmap-intensity": ["interpolate", ["linear"], ["zoom"],
            8, 0.9,
            12, 1.1,
            16, 1.35,
            20, 1.6
          ],

          "heatmap-opacity": 1,

          "heatmap-color": ["interpolate", ["linear"], ["heatmap-density"],
            0.00, "rgba(0,0,0,0)",
            0.30, "rgba(0,0,0,0)",
            0.50, "rgb(255,255,128)",
            0.75, "rgb(255,128,0)",
            1.00, "rgb(255,0,0)"
          ],

          "heatmap-opacity-transition":   { duration: 0, delay: 0 },
          "heatmap-color-transition":     { duration: 0, delay: 0 },
          "heatmap-radius-transition":    { duration: 0, delay: 0 },
          "heatmap-intensity-transition": { duration: 0, delay: 0 }
        },
        filter: buildFilter()
      });

      // invisible point layer (for hit-testing only)
      map.addLayer({
        id: "points",
        type: "circle",
        source: "temps",
        "source-layer": LAYER_NAME,
        minzoom: 8,
        paint: {
          "circle-opacity": 0,
          "circle-stroke-opacity": 0
        },
        filter: buildFilter()
      });

      $hour.addEventListener("input", applyFilters);
      $place.addEventListener("change", applyFilters);
      applyFilters();
    });

    // --- popup + chart code (unchanged) ---
    const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false });
    map.on("mousemove", (e) => { /* ... unchanged ... */ });
    map.on("click", async (e) => { /* ... unchanged ... */ });
  </script>
</body>
</html>

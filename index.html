<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Temperature Heatmap — PMTiles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- vendor bundles -->
  <script src="./vendor/maplibre-gl.js"></script>
  <script src="./vendor/pmtiles.js"></script>
  <script src="./vendor/basemaps.js"></script>
  <style>
    html, body { margin: 0; height: 100%; }
    #map { position: absolute; inset: 0; }
    #ui {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: #fff; padding: 12px; border-radius: 10px;
      font: 14px system-ui, sans-serif;
      box-shadow: 0 4px 20px rgba(0,0,0,.12);
      width: 320px;
    }
    #ui label { display: block; margin: 8px 0 4px; font-weight: bold; }
    #ui .row { display: flex; gap: 8px; align-items: center; }
    #ui .row input[type=range] { flex: 1; }
    #badge {
      position: absolute; bottom: 10px; left: 10px;
      background: #fff; padding: 6px 8px; border-radius: 8px;
      font: 12px system-ui, sans-serif;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="ui">
    <div class="row" style="justify-content:space-between;">
      <strong>Temperature Heatmap</strong>
      <span id="status" style="opacity:.7;">loading…</span>
    </div>

    <label for="hour">Hour</label>
    <div class="row">
      <input id="hour" type="range" min="0" max="23" step="1" value="19" />
      <span id="hourLabel" style="width:60px; text-align:right;">19:00</span>
    </div>

    <label for="place">Place</label>
    <select id="place">
      <option value="__all__">All places</option>
      <option value="sparafucile">sparafucile</option>
      <option value="parcote">parcote</option>
    </select>

    <label for="radius">Heatmap radius</label>
    <div class="row">
      <input id="radius" type="range" min="5" max="50" step="1" value="22" />
      <span id="radiusLabel" style="width:36px; text-align:right;">22</span>
    </div>

    <label for="intensity">Heatmap intensity</label>
    <div class="row">
      <input id="intensity" type="range" min="0.1" max="3" step="0.1" value="1.0" />
      <span id="intensityLabel" style="width:36px; text-align:right;">1.0</span>
    </div>
  </div>

  <div id="badge">PMTiles from Cloudflare R2 · MapLibre GL</div>

  <script>
    // Register PMTiles protocol
    (function() {
      const protocol = new window.pmtiles.Protocol();
      window.maplibregl.addProtocol("pmtiles", protocol.tile);
      window.__pmtilesProtocol = protocol;
    })();

    // Config
    const BASE = "https://pub-7d28cd0e85994386bd14b8b8fa86a6d7.r2.dev/all_temps.pmtiles";
    const PMTILES_URL = `${BASE}/all_temps.pmtiles`;
    const DATE = "2025-07-23";   // adjust if your data uses another date
    const INIT_CENTER = [10.80, 45.16];  // Mantova approx
    const INIT_ZOOM = 12.2;

    // URL params (?hour=19&place=sparafucile)
    const urlParams = new URLSearchParams(location.search);
    const initHour = Number(urlParams.get("hour") ?? 19);
    const initPlace = urlParams.get("place") ?? "__all__";

    // Build map style
    const style = {
      version: 8,
      sources: {
        basemap: {
          type: "raster",
          tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256
        },
        temps: {
          type: "vector",
          url: `pmtiles://${PMTILES_URL}`
        }
      },
      layers: [
        { id: "basemap", type: "raster", source: "basemap" },
        {
          id: "heat",
          type: "heatmap",
          source: "temps",
          "source-layer": "temps",
          paint: {
            "heatmap-weight": [
              "interpolate", ["linear"], ["get", "value"],
              20, 0,
              35, 1
            ],
            "heatmap-radius": 22,
            "heatmap-intensity": 1.0,
            "heatmap-opacity": 0.9,
            "heatmap-color": [
              "interpolate", ["linear"], ["heatmap-density"],
              0.0, "rgba(33,102,172,0)",
              0.2, "rgb(103,169,207)",
              0.4, "rgb(209,229,240)",
              0.6, "rgb(253,219,199)",
              0.8, "rgb(239,138,98)",
              1.0, "rgb(178,24,43)"
            ]
          },
          filter: ["==", ["get", "time"], `${DATE}T${String(initHour).padStart(2,"0")}:00`]
        }
      ]
    };

    const map = new window.maplibregl.Map({
      container: "map",
      center: INIT_CENTER,
      zoom: INIT_ZOOM,
      style
    });

    // UI elements
    const $status = document.getElementById("status");
    const $hour = document.getElementById("hour");
    const $hourLabel = document.getElementById("hourLabel");
    const $place = document.getElementById("place");
    const $radius = document.getElementById("radius");
    const $radiusLabel = document.getElementById("radiusLabel");
    const $intensity = document.getElementById("intensity");
    const $intensityLabel = document.getElementById("intensityLabel");

    $hour.value = String(initHour);
    $hourLabel.textContent = `${String(initHour).padStart(2,"0")}:00`;
    $place.value = initPlace;

    function currentTimeStr() {
      const h = Number($hour.value);
      return `${DATE}T${String(h).padStart(2,"0")}:00`;
    }

    function applyFilters() {
      const timeFilter = ["==", ["get", "time"], currentTimeStr()];
      const placeVal = $place.value;
      const combined = (placeVal === "__all__")
        ? timeFilter
        : ["all", timeFilter, ["==", ["get","place"], placeVal]];
      map.setFilter("heat", combined);
      history.replaceState(null, "", `?hour=${$hour.value}&place=${placeVal}`);
    }

    function applyPaint() {
      map.setPaintProperty("heat", "heatmap-radius", Number($radius.value));
      map.setPaintProperty("heat", "heatmap-intensity", Number($intensity.value));
      $radiusLabel.textContent = $radius.value;
      $intensityLabel.textContent = $intensity.value;
    }

    $hour.addEventListener("input", () => {
      $hourLabel.textContent = `${String($hour.value).padStart(2,"0")}:00`;
      applyFilters();
    });
    $place.addEventListener("change", applyFilters);
    $radius.addEventListener("input", applyPaint);
    $intensity.addEventListener("input", applyPaint);

    map.on("load", () => {
      $status.textContent = "ready";
      applyFilters();
      applyPaint();
    });

    map.on("error", (e) => {
      console.error(e);
      $status.textContent = "error";
    });
  </script>
</body>
</html>
